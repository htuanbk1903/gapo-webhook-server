const express = require("express");
const nodemailer = require("nodemailer");
const fs = require("fs");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json());

const transporter = nodemailer.createTransport({
  service: "gmail",
  auth: {
    user: "bidvgapochat@gmail.com",
    pass: "oist ncyn vnwy dopv", // ğŸ‘ˆ máº­t kháº©u á»©ng dá»¥ng Gmail
  },
});

app.get("/", (req, res) => {
  res.send("ğŸš€ Gapo Webhook Server Ä‘ang cháº¡y!");
});

app.post("/webhook", async (req, res) => {
  const messageBody = req.body;
  console.log("ğŸ“¥ Nháº­n message tá»« Gapo:", messageBody);

  // Sá»­a láº¡i Ä‘á»ƒ khÃ´ng dÃ¹ng Optional Chaining
  const messageText = (messageBody && messageBody.message && messageBody.message.text) ? messageBody.message.text : '';
  const email = (messageBody && messageBody.message && messageBody.message.user && messageBody.message.user.email) ? messageBody.message.user.email : '';
  const messageTimestamp = new Date().toLocaleString();

  const metadata = (messageBody && messageBody.message && messageBody.message.metadata) || {};
  console.log("ğŸ§© Metadata:", JSON.stringify(metadata, null, 2));

  // Láº¥y áº£nh tá»« metadata.media
  const mediaUrls = Array.isArray(metadata.media) ? metadata.media : [];
  const attachments = [];
  const imageInfo = [];

  mediaUrls.forEach((url, index) => {
    const filename = `image_${index + 1}.jpg`;
    attachments.push({
      filename: filename,
      path: url,
    });

    imageInfo.push({ filename, url });
  });

  if (imageInfo.length > 0) {
    fs.writeFileSync("image_info.json", JSON.stringify(imageInfo, null, 2), "utf-8");
    console.log("âœ… ÄÃ£ ghi thÃ´ng tin áº£nh vÃ o file 'image_info.json'");
  }

  if (messageText.toLowerCase().includes("táº¡o yÃªu cáº§u hpsm:")) {
    const emailBody =
      `ğŸ“ Ná»™i dung: ${messageText}\n` +
      `ğŸ‘¤ Email ngÆ°á»i gá»­i: ${email}\n` +
      `ğŸ•’ Thá»i gian: ${messageTimestamp}\n` +
      `ğŸ“ Sá»‘ áº£nh Ä‘Ã­nh kÃ¨m: ${attachments.length}`;

    try {
      await transporter.sendMail({
        from: '"BIDV Gapo Chat" <bidvgapochat@gmail.com>',
        to: "tuanhm3@bidv.com.vn",
        subject: "Táº¡o yÃªu cáº§u há»— trá»£ tá»« Gapo",
        text: emailBody,
        attachments: attachments,
      });
      console.log("âœ… ÄÃ£ gá»­i mail thÃ nh cÃ´ng");
    } catch (err) {
      console.error("âŒ Gá»­i mail lá»—i:", err);
    }
  }

  res.status(200).json({ status: "xá»­ lÃ½ xong" });
});

app.listen(PORT, () => {
  console.log(`âœ… Server Ä‘ang cháº¡y táº¡i cá»•ng ${PORT}`);
});
